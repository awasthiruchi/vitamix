<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="Description" content="Vitamix Recipes API Tool" />
    <meta name="robots" content="noindex" />
    <title>Vitamix Recipes Tool</title>
    <style>
      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background-color: #f5f5f5;
        height: 100%;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
      }

      .credentials-notice {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
        color: #856404;
      }

      .form-section {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      input[type="text"],
      input[type="password"],
      input[type="date"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      input[type="text"]:focus,
      input[type="password"]:focus,
      input[type="date"]:focus {
        outline: none;
        border-color: #4CAF50;
      }

      .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      button {
        background-color: #4CAF50;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: #45a049;
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .loading.active {
        display: block;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4CAF50;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
      }

      .error.active {
        display: block;
      }

      .results {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: none;
      }

      .results.active {
        display: block;
      }

      .results h2 {
        margin-top: 0;
        color: #333;
      }

      .recipe-count {
        font-size: 18px;
        color: #4CAF50;
        font-weight: 600;
        margin-bottom: 20px;
      }

      pre {
        background-color: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 13px;
        line-height: 1.5;
      }

      .actions {
        margin-top: 0;
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
      }

      .btn-secondary {
        background-color: #6c757d;
      }

      .btn-secondary:hover {
        background-color: #5a6268;
      }

      .recipe-list {
        margin-bottom: 20px;
      }

      .recipe-item {
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #fafafa;
        transition: box-shadow 0.2s;
      }

      .recipe-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .recipe-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .recipe-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      .recipe-status {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .recipe-status.updated {
        background-color: #d4edda;
        color: #155724;
      }

      .recipe-status.deleted {
        background-color: #f8d7da;
        color: #721c24;
      }

      .recipe-status.new {
        background-color: #d1ecf1;
        color: #0c5460;
      }

      .recipe-meta {
        display: flex;
        gap: 20px;
        font-size: 13px;
        color: #666;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      .recipe-meta span {
        display: flex;
        align-items: center;
      }

      .recipe-meta strong {
        margin-right: 5px;
        color: #333;
      }

      .recipe-brands {
        margin-top: 10px;
      }

      .recipe-brands-title {
        font-size: 14px;
        font-weight: 600;
        color: #555;
        margin-bottom: 8px;
      }

      .brand-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .brand-tag {
        background-color: #e9ecef;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        color: #495057;
      }

      .brand-tag.primary {
        background-color: #4CAF50;
        color: white;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Vitamix Recipes Tool</h1>
      <p class="subtitle">Fetch updated recipes from Vitamix CalcMenu API</p>

      <div class="credentials-notice" id="credentialsNotice">
        <strong>Credentials required:</strong> Add <code>?user=YOUR_USER&pw=YOUR_PASSWORD</code> to the URL
      </div>

      <div class="form-section">
        <form id="recipesForm" method="GET">
          <div class="form-group">
            <label for="userId">User ID</label>
            <input type="text" id="userId" name="user" required />
            <div class="help-text">From query parameter: ?user=...</div>
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="pw" required />
            <div class="help-text">From query parameter: ?pw=...</div>
          </div>

          <div class="form-group">
            <label for="dateUpdated">Date Updated</label>
            <input type="date" id="dateUpdated" name="date" />
            <div class="help-text">Leave empty to get all recipes, or specify a date to get recipes updated since that date</div>
          </div>

          <button type="submit" id="submitBtn">Fetch Recipes</button>
        </form>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Fetching recipes from API...</p>
      </div>

      <div class="error" id="error"></div>

      <div class="results" id="results">
        <h2>Results</h2>
        <div class="recipe-count" id="recipeCount"></div>
        <div class="actions">
          <button onclick="toggleRawXML()" id="toggleBtn">Show Raw XML</button>
          <button onclick="copyToClipboard()">Copy XML</button>
          <button onclick="downloadJSON()" class="btn-secondary">Download XML</button>
        </div>
        <div id="recipeList" class="recipe-list"></div>
        <pre id="responseData" style="display: none;"></pre>
      </div>
    </div>

    <script>
      // Parse query parameters
      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          user: params.get('user') || '',
          pw: params.get('pw') || '',
          date: params.get('date') || ''
        };
      }

      // Initialize form with query params
      function initializeForm() {
        const params = getQueryParams();
        const userIdInput = document.getElementById('userId');
        const passwordInput = document.getElementById('password');
        const dateUpdatedInput = document.getElementById('dateUpdated');
        const credentialsNotice = document.getElementById('credentialsNotice');

        if (params.user) {
          userIdInput.value = params.user;
        }

        if (params.pw) {
          passwordInput.value = params.pw;
        }

        if (params.date) {
          dateUpdatedInput.value = params.date;
        }

        if (params.user && params.pw) {
          credentialsNotice.style.display = 'none';
        }
      }

      // Format date for SOAP request (mm/dd/yyyy)
      function formatDate(dateString) {
        if (!dateString) return '';
        // Convert from YYYY-MM-DD (date input format) to mm/dd/yyyy
        const [year, month, day] = dateString.split('-');
        return `${month}/${day}/${year}`;
      }

      let currentResponseData = null;

      // Make GET request with query params
      async function fetchRecipes(userId, password, dateUpdated) {
        // Create query parameters
        const queryParams = new URLSearchParams({
          ID: userId,
          PSWD: password,
          Kiosk: 'Website',
          CodeTranslation: '1',
          DateUpdated: formatDate(dateUpdated)
        });
        
        // Use CORS proxy
        const apiUrl = `https://vitamix.calcmenuweb.com/ws/service.asmx/GetUpdatedRecipes?${queryParams.toString()}`;
        const corsProxy = 'https://little-forest-58aa.david8603.workers.dev/?url=';
        
        const response = await fetch(corsProxy + encodeURIComponent(apiUrl), {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const xmlText = await response.text();
        return xmlText;
      }

      // Display results
      function displayResults(data, rawXml) {
        const resultsDiv = document.getElementById('results');
        const responseDataPre = document.getElementById('responseData');
        const recipeCount = document.getElementById('recipeCount');
        const recipeList = document.getElementById('recipeList');

        currentResponseData = { data, rawXml };

        // Parse XML and display recipes
        try {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(rawXml, 'text/xml');
          const recipes = xmlDoc.querySelectorAll('Recipes');

          recipeCount.textContent = `Recipes found: ${recipes.length}`;
          
          // Clear previous results
          recipeList.innerHTML = '';

          // Create list items for each recipe
          recipes.forEach((recipe) => {
            const code = recipe.getAttribute('Code');
            const number = recipe.getAttribute('Number');
            const name = recipe.getAttribute('Name');
            const status = recipe.getAttribute('Status');
            const dateCreated = recipe.getAttribute('DateCreated');
            const dateUpdated = recipe.getAttribute('DateUpdated');

            // Get brands
            const brands = recipe.querySelectorAll('Brand');
            
            // Create recipe item
            const recipeItem = document.createElement('div');
            recipeItem.className = 'recipe-item';

            // Status class
            const statusClass = status.toLowerCase();

            recipeItem.innerHTML = `
              <div class="recipe-header">
                <h3 class="recipe-title">${name}</h3>
                <span class="recipe-status ${statusClass}">${status}</span>
              </div>
              <div class="recipe-meta">
                <span><strong>Code:</strong> ${code}</span>
                <span><strong>Number:</strong> ${number}</span>
                <span><strong>Created:</strong> ${new Date(dateCreated).toLocaleDateString()}</span>
                <span><strong>Updated:</strong> ${new Date(dateUpdated).toLocaleDateString()}</span>
              </div>
              ${brands.length > 0 ? `
                <div class="recipe-brands">
                  <div class="recipe-brands-title">Brands:</div>
                  <div class="brand-list">
                    ${Array.from(brands).map(brand => {
                      const brandName = brand.querySelector('BrandName')?.textContent || 'Unknown';
                      const classification = brand.querySelector('Classification')?.textContent || '';
                      const isPrimary = classification.toLowerCase() === 'primary';
                      return `<span class="brand-tag ${isPrimary ? 'primary' : ''}">${brandName}</span>`;
                    }).join('')}
                  </div>
                </div>
              ` : ''}
            `;

            recipeList.appendChild(recipeItem);
          });

          // Store raw XML
          responseDataPre.textContent = rawXml;
          resultsDiv.classList.add('active');
        } catch (e) {
          console.error('Error parsing recipes:', e);
          showError(`Error parsing response: ${e.message}`);
        }
      }

      // Toggle raw XML display
      function toggleRawXML() {
        const responseDataPre = document.getElementById('responseData');
        const toggleBtn = document.getElementById('toggleBtn');
        
        if (responseDataPre.style.display === 'none') {
          responseDataPre.style.display = 'block';
          toggleBtn.textContent = 'Hide Raw XML';
        } else {
          responseDataPre.style.display = 'none';
          toggleBtn.textContent = 'Show Raw XML';
        }
      }

      // Show error
      function showError(message) {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = message;
        errorDiv.classList.add('active');
        setTimeout(() => {
          errorDiv.classList.remove('active');
        }, 5000);
      }

      // Copy to clipboard
      function copyToClipboard() {
        const responseData = document.getElementById('responseData').textContent;
        navigator.clipboard.writeText(responseData).then(() => {
          alert('Copied to clipboard!');
        }).catch(err => {
          console.error('Failed to copy:', err);
          alert('Failed to copy to clipboard');
        });
      }

      // Download as JSON
      function downloadJSON() {
        const responseData = document.getElementById('responseData').textContent;
        const blob = new Blob([responseData], { type: 'text/xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `vitamix-recipes-${new Date().toISOString().split('T')[0]}.xml`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Make API call if query params are present
      async function makeApiCallFromParams() {
        const params = getQueryParams();
        
        // Only make API call if user and password are present
        if (!params.user || !params.pw) {
          return;
        }

        const loadingDiv = document.getElementById('loading');
        const submitBtn = document.getElementById('submitBtn');
        const resultsDiv = document.getElementById('results');

        // Reset state
        resultsDiv.classList.remove('active');
        document.getElementById('error').classList.remove('active');

        // Show loading
        loadingDiv.classList.add('active');
        submitBtn.disabled = true;

        try {
          const xmlResponse = await fetchRecipes(params.user, params.pw, params.date);
          displayResults(null, xmlResponse);
        } catch (error) {
          console.error('Error:', error);
          showError(`Error: ${error.message}`);
        } finally {
          loadingDiv.classList.remove('active');
          submitBtn.disabled = false;
        }
      }

      // Initialize on page load
      initializeForm();
      makeApiCallFromParams();
    </script>
  </body>
</html>

